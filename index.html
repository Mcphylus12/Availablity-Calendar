<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Availability Lobby</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    padding: 20px;
  }
  h2 {
    margin-top: 40px;
  }
  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    max-width: 700px;
  }
  .day-header {
    font-weight: bold;
    text-align: center;
  }
  .date {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
    cursor: pointer;
  }
  .date.busy {
    background: #ffb3b3;
  }
  .date.empty {
    border: none;
    cursor: default;
  }
  .month {
    margin-bottom: 40px;
  }
  #form-container {
    max-width: 400px;
  }
  label {
    display: block;
    margin-top: 10px;
  }
</style>
</head>
<body>

<div id="form-container">
  <h1>Create Availability Lobby</h1>

  <label>
    Start Month:
    <input type="month" id="startMonth" required>
  </label>

  <label>
    End Month:
    <input type="month" id="endMonth" required>
  </label>

  <label>
    Weekday of the 1st of Start Month:
    <select id="startWeekday">
      <option value="0">Sunday</option>
      <option value="1">Monday</option>
      <option value="2">Tuesday</option>
      <option value="3">Wednesday</option>
      <option value="4">Thursday</option>
      <option value="5">Friday</option>
      <option value="6">Saturday</option>
    </select>
  </label>

  <label>
    <input type="checkbox" id="leapYear">
    Treat February as Leap Year
  </label>

  <button id="startBtn">Create Calendar</button>
</div>

<div id="calendar-container"></div>
<div id="merge-container" style="margin-top:40px; max-width:600px; display:none;">
  <h3>Add someone else's availability</h3>
  <input
    id="mergeInput"
    type="text"
    placeholder="Paste shared link or fragment here"
    style="width:100%; padding:8px;"
  />
  <button id="mergeBtn" style="margin-top:10px;">
    Merge blocked dates
  </button>
  <div id="mergeError" style="color:red; margin-top:8px;"></div>
</div>
<script>
  let currentState = null;
const calendarContainer = document.getElementById("calendar-container");
const formContainer = document.getElementById("form-container");

const weekdayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

function daysInMonth(year, month, leap) {
  if (month === 1) return leap ? 29 : 28;
  return [31,28,31,30,31,30,31,31,30,31,30,31][month];
}

function* monthRange(start, end) {
  let [sy, sm] = start.split("-").map(Number);
  let [ey, em] = end.split("-").map(Number);
  while (sy < ey || (sy === ey && sm <= em)) {
    yield [sy, sm - 1];
    sm++;
    if (sm === 13) { sm = 1; sy++; }
  }
}

function buildIndexMap(state) {
  const map = new Map();
  let index = 0;

  for (const [y, m] of monthRange(state.start, state.end)) {
    const days = daysInMonth(y, m, state.leap);
    for (let d = 1; d <= days; d++) {
      const iso = `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      map.set(iso, index++);
    }
  }
  return map;
}

function parseAnyFragment(input) {
  const hashIndex = input.indexOf("#");
  if (hashIndex === -1) return null;
  const fragment = input.slice(hashIndex + 1);
  const p = new URLSearchParams(fragment);
  if (!p.get("s")) return null;
  return p;
}
  
function encodeBusy(busySet, indexMap) {
  return [...busySet]
    .map(d => indexMap.get(d).toString(36))
    .sort((a,b) => parseInt(a,36) - parseInt(b,36))
    .join(".");
}

function decodeBusy(encoded, indexMap) {
  const reverse = [...indexMap.entries()].reduce((a,[k,v]) => {
    a[v] = k;
    return a;
  }, {});
  return new Set(
    encoded.split(".").filter(Boolean).map(x => reverse[parseInt(x,36)])
  );
}

function updateFragment(state, indexMap) {
  const p = new URLSearchParams();
  p.set("s", state.start);
  p.set("e", state.end);
  p.set("w", state.weekday);
  p.set("l", state.leap ? "1" : "0");
  if (state.busy.size) {
    p.set("b", encodeBusy(state.busy, indexMap));
  }
  location.hash = p.toString();
}

function parseFragment() {
  if (!location.hash) return null;
  const p = new URLSearchParams(location.hash.slice(1));
  if (!p.get("s")) return null;

  const baseState = {
    start: p.get("s"),
    end: p.get("e"),
    weekday: Number(p.get("w")),
    leap: p.get("l") === "1",
    busy: new Set()
  };

  const indexMap = buildIndexMap(baseState);
  if (p.get("b")) {
    baseState.busy = decodeBusy(p.get("b"), indexMap);
  }
  return { state: baseState, indexMap };
}

function renderCalendar(state) {
  calendarContainer.innerHTML = "";
  formContainer.style.display = "none";

  const indexMap = buildIndexMap(state);
  let weekdayOffset = state.weekday;

  for (const [year, month] of monthRange(state.start, state.end)) {
    const monthDiv = document.createElement("div");
    monthDiv.className = "month";

    const title = document.createElement("h2");
    title.textContent = `${year}-${String(month+1).padStart(2,"0")}`;
    monthDiv.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "calendar";

    weekdayNames.forEach(d => {
      const h = document.createElement("div");
      h.className = "day-header";
      h.textContent = d;
      grid.appendChild(h);
    });

    for (let i = 0; i < weekdayOffset; i++) {
      const e = document.createElement("div");
      e.className = "date empty";
      grid.appendChild(e);
    }

    const totalDays = daysInMonth(year, month, state.leap);

    for (let d = 1; d <= totalDays; d++) {
      const iso = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      const cell = document.createElement("div");
      cell.className = "date";
      cell.textContent = d;

      if (state.busy.has(iso)) cell.classList.add("busy");

      cell.onclick = () => {
        state.busy.has(iso)
          ? state.busy.delete(iso)
          : state.busy.add(iso);

        cell.classList.toggle("busy");
        updateFragment(state, indexMap);
      };

      grid.appendChild(cell);
    }

    weekdayOffset = (weekdayOffset + totalDays) % 7;
    monthDiv.appendChild(grid);
    calendarContainer.appendChild(monthDiv);
  }

  document.getElementById("merge-container").style.display = "block";
}

document.getElementById("startBtn").onclick = () => {
  const state = {
    start: startMonth.value,
    end: endMonth.value,
    weekday: Number(startWeekday.value),
    leap: leapYear.checked,
    busy: new Set()
  };
  const indexMap = buildIndexMap(state);
  updateFragment(state, indexMap);
  currentState = state;
  renderCalendar(state);
};

const parsed = parseFragment();
if (parsed) {
  currentState = parsed.state;
  renderCalendar(parsed.state);
}

  document.getElementById("mergeBtn").onclick = () => {
  const input = document.getElementById("mergeInput").value.trim();
  const error = document.getElementById("mergeError");
  error.textContent = "";

  const p = parseAnyFragment(input);
  if (!p) {
    error.textContent = "Invalid link or fragment.";
    return;
  }

  // Validate calendar compatibility
  if (
    p.get("s") !== currentState.start ||
    p.get("e") !== currentState.end ||
    p.get("w") !== String(currentState.weekday) ||
    p.get("l") !== (currentState.leap ? "1" : "0")
  ) {
    error.textContent = "Calendar scope does not match.";
    return;
  }

  if (!p.get("b")) {
    error.textContent = "No blocked dates found in link.";
    return;
  }

  const indexMap = buildIndexMap(currentState);
  const incomingBusy = decodeBusy(p.get("b"), indexMap);

  incomingBusy.forEach(d => currentState.busy.add(d));

  updateFragment(currentState, indexMap);
  renderCalendar(currentState);

  document.getElementById("mergeInput").value = "";
};
</script>


</body>
</html>
